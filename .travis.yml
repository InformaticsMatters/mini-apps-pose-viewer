---

os: linux
services:
- docker

env:
  global:
  - NAMESPACE=informaticsmatters
  - IMAGE=im-mini-apps
  # Our CI/CD DOCKER username and password
  # These encrypted values are branch-sensitive (only available to master)
  # so these variables are not available in stages like 'before_script'.
  - secure: "C+o29DGKh/PhNGHsqftulL49/p03SYo37et8CgJSaAcOoVvPWXYq30tG6emjksI2m+FL0EXwoSbAWIiksEnNGwv/8cj+T2tGjmH9eiQzIk4R2obnyRyT8BrTCbUa85sCc0MGQZoUTzvBR+3HPCwB3yqD/o0AaDXIBwx7y+UuQbL1rIQuG+Vko1lh+Z3jRQjLxsKpu7pOzfF4LwOtLKkLYtwl1qNU34ea7BQh76FbfJgCzHvOb+px7ZLjxCwLKj7N2eSgjKyFwTLHVgHgglYqOb1mDIr4glrG4JJ9hKeo9Qn3eO33dgFn8AZyIc2X/YJVQQV/2e65XBvyyERKKyiEQ3M1BVFsLgiyBJFp5UF0A0M0/L65lH338irQfyuOiw0vrXtxeIE6ykGrxaUrNZ0tApHrXEIT0fieqjm/qWvi2LqO9cWYGeeG6+MJPfg/pIBau4Zzdb4rTwz2gDQirbhaKLlSVyn94+rB5doUccJyF4fpt7S3NTHqWMkcqoEw0Ntoj8boa6uKFlWlxxrXB7u7QyD41ovtSOIb1Nh14NDM6lv/9TmYLoBMU5/S90H8V6KSjQaQbzirVoAy5UluTbFWzVdAV42NjVp+dnzhSFMIOHmhZbKgyjzhw7ERZmDqarI1m2ZffsKZPZps8+4WELg5cRtNXgJqqQrDdiJxUYiLosY="
  - secure: "j09KJeYNTRrtjvT3QsguA6iLfqiVmfdmVHro8mk58TXL7fe+Tl0VQInXS/ktifAjhwd2+U5P7hFeBm+xmJO71AEajlBYs7UwG03kyfWUnqlD6k8mFvWxuSg02a/cx4/MfUvcY/RVIlW0TtlgHCLtDuyCO+aJaNBLJFMGn7Ck02mQmV0d9no76qbZFJ4svIGYHaxuIhaslfBnE5vqm8YziYH3Q1GuIs6fK7Rfx3Z3j6x7j2r/0wIHVLEnRNRVEnoFCSvHmV3gUONbPSrMmho+3B5BxyYadIAvAB29w96kP2/YRxT1NiUL0WkK8mfqCOvx05Sg+0pk2P8smXKnbxuDuNduc0SVrRD7R6ynul21tE1oIdfA+Qkw5jZfN4LyP2IMhu+m7gtuFzfbk4j13Yl1pIgrLvmR8FTIiLawy2D/ualGlYwieEByVFDXyEdjcumCGmaz+ni4wrveMNWF01XwV5CJ8bXGkO986hA5X4JXAoE2ErHu+Xy8joolvjl4gCYxJGZDxH4evdna5E8yS5oE2lDpFjlrKX7t6gIBPtI3sUCuE7SZRZZJO+xX9J2VeINHt7GXooOO+L01vJV3Pr7Xm8x57WXVHS1crB/xUIcUY9oS7wG0W+cZjI0AZqax+uit7m3NqB0fvyVxS8x9ycU7BeZK7wjQqMun8MbNdbNgJDQ="

stages:
- name: publish latest
  if: |
    branch = master
- name: test latest
  if: |
    branch = master
- name: publish tag
  if: |
    tag IS present
- name: publish stable
  if: |
    tag IS present \
    AND tag =~ ^([0-9]+\.){1,2}[0-9]+$

jobs:
  include:

  # Publish-stage jobs...
  # Every successful master build results in a latest image
  # and every tag results in a tagged image in Docker Hub.

  - stage: publish latest
    name: Latest Image
    script:
    # Build and push the pipelines-rdkit image and its sd-poster
    - docker login -u=${DOCKER_USERNAME} -p=${DOCKER_PASSWORD}
#    - docker build -t ${NAMESPACE}/${IMAGE}:latest .
#    - docker push ${NAMESPACE}/${IMAGE}:latest

#  - stage: publish tag
#    name: Tagged Image
#    script:
#    # Build and push the pipelines-rdkit image and its sd-poster
#    - docker login -u "${DOCKER_USERNAME}" -p "${DOCKER_PASSWORD}"
#    - docker build -t ${NAMESPACE}/${IMAGE}:${TRAVIS_TAG} .
#    - docker push ${NAMESPACE}/${IMAGE}:${TRAVIS_TAG}

#  - stage: publish stable
#    name: Stable Image
#    script:
#    # Pull the corresponding pipelines-rdkit image tag and push it as 'stable'
#    - docker login -u "${DOCKER_USERNAME}" -p "${DOCKER_PASSWORD}"
#    - docker pull ${NAMESPACE}/${IMAGE}:${TRAVIS_TAG}
#    - docker tag ${NAMESPACE}/${IMAGE}:${TRAVIS_TAG} ${NAMESPACE}/${IMAGE}:stable
#    - docker push ${NAMESPACE}/${IMAGE}:stable
